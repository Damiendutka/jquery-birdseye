// Generated by CoffeeScript 1.3.3
(function(){var e;e=jQuery;e.fn.extend({mapSearch:function(t){var n,r,i,s,o,u,a,f,l,c=this;l={initial_coordinates:[40,-100],initial_zoom:4,tile_layer:"http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",request_uri:"",request_geo_params:{ne_lat:function(e){return e.getBounds().getNorthEast().lat},ne_lng:function(e){return e.getBounds().getNorthEast().lng},sw_lat:function(e){return e.getBounds().getSouthWest().lat},sw_lng:function(e){return e.getBounds().getSouthWest().lng}},response_json_key:"results",response_params_latlng:function(e){return[e.latitude,e.longitude]},response_params_pagination:{page:function(e){return e.meta.page},per_page:function(e){return e.meta.per_page},total_pages:function(e){return e.meta.total_pages},count:function(e){return e.meta.count}},results_el:e("#mapsearch-results"),results_template:function(e,t){return"        <div># "+e+": "+t.name+"</div>        "},pagination_el:e("#mapsearch-pagination"),pagination_template:function(e){return"          Current Page: "+e.page+"<br />          Total Pages: "+e.total_pages+"<br />          Count: "+e.count+"<br />          Per Page: "+e.per_page+"<br />          <a href='#' data-mapsearch-role='change-page' data-mapsearch-pagenumber='"+(e.page-1)+"'>previous page</a><br />          <a href='#' data-mapsearch-role='change-page' data-mapsearch-pagenumber='"+(e.page+1)+"'>next page</a>        "}};l=e.extend(l,t);n={};u={};o=[];s=L.map(this[0]).setView(l.initial_coordinates,l.initial_zoom);L.tileLayer(l.tile_layer).addTo(s);i=function(t){var r,i,o,u;o=t||n;u=l.request_geo_params;for(i in u){r=u[i];o[i]=r(s)}n=o;return e.ajax({url:l.request_uri+"?"+e.param(o),type:"GET",success:function(e){l.response_json_key?f(e[l.response_json_key]):f(e);return a(e)}})};f=function(t){var n,r,i;l.results_el.html("");for(r=0,i=o.length;r<i;r++){n=o[r];s.removeLayer(n)}return e(t).each(function(e,t){var n;e+=1;n=L.marker(l.response_params_latlng(t),{icon:new L.NumberedDivIcon({number:e})});o.push(n.addTo(s));return l.results_el.append(l.results_template(e,t))})};a=function(e){var t;l.pagination_el.html("");t={page:l.response_params_pagination.page(e),per_page:l.response_params_pagination.per_page(e),total_pages:l.response_params_pagination.total_pages(e),count:l.response_params_pagination.count(e)};l.pagination_el.append(l.pagination_template(t));return u=t};s.on("dragend zoomend",function(){return r.change_page(1)});e(document).on("click","[data-mapsearch-role=change-page]",function(){return r.change_page(e(this).data("mapsearch-pagenumber"))});r={};r.set_view=arguments.callee.set_view=function(e,t,n){n==null&&(n=!0);s.setView(e,t);if(n)return r.update()};r.update=arguments.callee.update=function(e){return i(e)};return r.change_page=arguments.callee.change_page=function(t){if(t>u.total_pages||t===0)return;return i(e.extend(n,{page:t}))}}})}).call(this);